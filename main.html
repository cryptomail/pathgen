
<!--
/*
 Pathgen.html
 Joshua Teitlebaum 4/8/2014
 outputs JSON, takes in JSON for path representations
*/

 -->
<html>
    <head>
        <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
        <script src="http://code.jquery.com/ui/1.10.1/jquery-ui.js"></script>
        <script src="raphael-min.js"></script>
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.1/themes/base/jquery-ui.css" />
        <style>
            .ui-dialog-title {
                font-size:10px !important;
            }
            .ui-widget-content {
                font-size:10px !important;
            }
            div.select{
                height:30px;
            
            }
            div.delbutton
            {
                border-style:dotted;
                border-width:1px;
                background-color:red;
                width:30px;
                height:20px;
                float: left;
                
                
            }
            div.runsimulator
            {
                border-style:dotted;
                border-width:1px;
                background-color:darkgreen;
                width:30px;
                height:20px;
                float: left;
            }
            div.outputjson
            {
                border-style:dotted;
                border-width:1px;
                background-color:lightblue;
                width:30px;
                height:20px;
                float: left;
            }
            div.inputjson
            {
                border-style:dotted;
                border-width:1px;
                background-color:lightgreen;
                width:30px;
                height:20px;
                float: left;
            }

            img.ball
            {
                width:15px;
                height:15px;
            
            }
            canvas.ball
            {
                
                width:15px;
                height:15px;
                
            }
            div.ball
            {
                border-style:solid;
                border-width:1px;
                color:#000000;
                font-size:8pt;
                overflow:none;
                
            }
            div.ballselected
            {
                border-style:solid;
                border-width:1px;
                border-color:red;
                color:#000000;
                font-size:8pt;
                overflow:none;
                
            }
            
            div.main
            {
                position:absolute;
                background:white;
                top:8px;
                left:110px;
                width:320px;
                height:480px;
                border-style:solid;
                border-width:2px;
                
            }
            div.simulator
            {
                visibility:hidden;
                position:absolute;
                background:white;
                top:8px;
                left:110px;
                width:320px;
                height:480px;
                border-style:solid;
                border-width:2px;
                
            }
            div.inputarea
            {
                position:absolute;
                background:white;
                top:8;
                left:432;
                width:320px;
                height:480px;
                border-style:solid;
                border-width:2px;
                
            }

            div.leftbar
            {
                    
                width:100px;
                height:480px;
                border-style:solid;
                border-width:2px;
                overflow:scroll;
                
            }
            
            div.bottombar
            {
                
                width:420px;
                height:100px;
                border-style:solid;
                border-width:2px;
                
            }
            </style>
    </head>
    <body>
        <div id="main" class="main">
        
        </div>
        <div id="simulator" class="simulator">
        
        </div>
        <div id="inputarea" class="inputarea"> <textarea id="inputareatxt" style="width:100%;height:100%;"></textarea></div>
        <div id="leftbar" class="leftbar">
            
        </div>
        <div class="bottombar">
            <form>
                
                <div id="delbutton" class="delbutton">del</div>
                
                
                x: <input id="itemx" type="text" maxlength="4" size="4" ></input>
                y:    <input id="itemy" type="text" maxlength="4" size="4" ></input>
                re-ordinal:    <input id="itemordinal" type="text" maxlength="4" size="4" ></input>
                rotation:    <input id="itemrotation" type="text" maxlength="4" size="4" ></input>
                defaulttime: <input id="defaulttime" type="text" maxlength="4" size="4" value="5" ></input>
                pathname: <input id="pathname" type="text" maxlength="25" size="15" value="" ></input>
                <br/>
                <div id="outputjson" class="outputjson">out</div>
                <div id="inputjson" class="inputjson">in</div>
                <div id="runsimulator" class="runsimulator">run</div>
                <select id="pathnames" maxlength="25">
                                    </select>
               
                
            </form>
        </div>
        <div id="dialog-form" title="Time in segment">
            
            
            <form>
                <fieldset>
                    <label for="name">time in seconds:</label>
                    <input type="text" name="time" id="time" class="text ui-widget-content ui-corner-all" />
                </fieldset>
            </form>
        </div>
        <script>
            var g_numberdudes = 0;
            var g_segment_times = [];
            var g_pathnames = [];
            var g_running = false;
            var g_raphaelcanvas = null;
            var g_current_ballid = 1;
            var g_current_point = null;
            var g_current_line = null;
            var g_set = null;
            function Dialog_OnOK()
            {
                
                var bValid = true;
                    
                if ( bValid ) {
                    setsegmenttime($("#dialog-form").attr("active_segment"),$("#time").val());
                    rendersegments();
                    $( "#dialog-form" ).dialog( "close" );
                }
                
            }
            
            function setsegmenttime(segmentid, theval)
            {
                console.log("Segmentid " + segmentid + " val " + theval);
                g_segment_times[segmentid] = theval;
            }
            
            $('#time').keypress(function(e) {
                                if (e.keyCode == '13') {
                                e.preventDefault();
                                Dialog_OnOK();
                                }
                                });

            $( "#dialog-form" ).dialog({
                                       autoOpen: false,
                                       height: 200,
                                       width: 200,
                                       modal: true,
                                       buttons: {
                                       "OK": Dialog_OnOK,
            Cancel: function() {
                $( this ).dialog( "close" );
            }
            },
           
            });
            $("#delbutton").hover(function() {
                                           $(this).css('cursor','pointer');
                                           
                                           }, function() {
                                           
                                           $(this).css('cursor','auto');
                                           
                                           });
            $("#outputjson").hover(function() {
                                  $(this).css('cursor','pointer');
                                  
                                  }, function() {
                                  
                                  $(this).css('cursor','auto');
                                  
                                  });
            $("#runsimulator").hover(function () {
                $(this).css('cursor', 'pointer');

            }, function () {

                $(this).css('cursor', 'auto');

            });
            $("#inputjson").hover(function() {
                                   $(this).css('cursor','pointer');
                                   
                                   }, function() {
                                   
                                   $(this).css('cursor','auto');
                                   
                                   });

            $("#itemx").change(function() {
                               userchangedxyordinal();
                               });
            $("#itemy").change(function() {
                               userchangedxyordinal();
                               });
            $("#itemordinal").change(function() {
                               userchangedxyordinal();
                               });
            $("#itemrotation").change(function() {
                                     userchangedrotation();
                                     });

            $("#pathnames").change(pathselected);
            
            function mainmousemove(event)
            {
                //console.log(event.offsetX + " " + event.offsetY);
               
            }
            function reordinalto(selectedid, targetordinal)
            {
                if(selectedid > targetordinal)
                {
                    n = $("div.ball").length;
                    
                    for(x=n; x >= targetordinal; x--)
                    {
                        /*
                         1) take everything from the target and push its id up one
                         2) assign the selected id to the target
                        */
                        divid = "ball" + x;
                        jqdivid = "#" + divid;
                        canvasid = "canvas" + (parseInt(x) + 1);
                        
                        jqcanvasid = "#" + canvasid;
                        rotation = $(jqdivid).attr("rot");
                        newdivid = "ball" + (parseInt(x) + 1);
                        jqnewdivid = "#" + newdivid;
                        $(jqdivid).empty();
                        
                        //$("#ball"+x).html("<img class='ball' src='ball.jpg'>" + (parseInt(x)+1));
                        
                        $(jqdivid).attr("id",  newdivid);
                        $(jqdivid).attr("rot",  rotation);
                        $(jqnewdivid).html(canvashtml((parseInt(x) + 1)));
                        //console.log("ball" + x + "goes to " + (parseInt(x)+1));
                        e = $(jqcanvasid)[0];
                        drawcanvas(e);


                        
                    }
                    divid = "ball" + (n + 1);
                    jqdivid = "#" + divid;
                    canvasid = "canvas" + targetordinal;
                    jqcanvasid = "#" + canvasid;
                    rotation = $(jqdivid).attr("rot");
                    newjqdivid = "#ball" + targetordinal;

                    //$("#ball"+(n+1)).html("<img class='ball' src='ball.jpg'>" + targetordinal);
                    $(jqdivid).empty();
                    
                    $(jqdivid).attr("id",  "ball"+ targetordinal);
                    $(jqdivid).attr("rot",  rotation);
                    $(newjqdivid).html(canvashtml(targetordinal));
                    e = $(jqcanvasid)[0];
                    
                    drawcanvas(e);

                    //console.log("ball" + (n+1) + "goes to " + targetordinal);
                }
            }

            function _InitRaphaelCanvas(node)
            {
                
                if(g_raphaelcanvas == null)
                {
                    g_raphaelcanvas = Raphael(node.offsetLeft,node.offsetTop,node.clientWidth,node.clientHeight);
                    g_set = g_raphaelcanvas.set();
                }
                g_raphaelcanvas.clear();
                
                
            }

            function setrotation(itemid, targetrotation)
            {
                jqdivid = "#ball" + itemid;
                jqcanvasid = "#canvas" + itemid;
                
                $(jqdivid).attr("rot",  targetrotation);
                e = $(jqcanvasid)[0];
                
                drawcanvas(e)
                
            }
            function userchangedrotation()
            {
                if($(".ballselected") == null || $(".ballselected").length == 0)
                {
                    return;
                }
                selectedid =  _getid($(".ballselected")[0].id);
                //console.log($("#ball" + selectedid)[0]);
                $("#ball" + selectedid).css('left',  $("#itemx").val());
                $("#ball" + selectedid).css('top',  $("#itemy").val());
                
                               
                targetrotation = parseInt($("#itemrotation").val());
                
                setrotation(selectedid,targetrotation);
                rendersegments();
  
            }
            function userchangedxyordinal()
            {
                if($(".ballselected") == null || $(".ballselected").length == 0)
                {
                    return;
                }
                selectedid =  _getid($(".ballselected")[0].id);
                //console.log($("#ball" + selectedid)[0]);
                $("#ball" + selectedid).css('left',  $("#itemx").val());
                $("#ball" + selectedid).css('top',  $("#itemy").val());
                
                targetordinal = parseInt($("#itemordinal").val());
                
                if(targetordinal <= 0 || selectedid > g_numberdudes || selectedid <=0 || selectedid == targetordinal || targetordinal > g_numberdudes)
                {
                    /*
                     don't reordinal
                    */
                    console.log("not reord");
                }
                else
                {
                    reordinalto(selectedid,targetordinal);
                    
                }
                targetrotation = parseInt($("#itemrotation").val());
                
                
                rendersegments();
                
            }
            
            function line(x1, y1, x2, y2) {
                c = $("#main");
                var dx = Math.abs(x2-x1);
                var dy = Math.abs(y2-y1);
                var d = Math.max(dx, dy);
                var i=0;
                for(i=0; i < d; i++) {
                    //var img = $(document.createElement('img')).attr('src', 'blank.gif').css({'backgroundColor': '#000;'});
                    //var img = $(document.createElement('img')).attr('src', 'blank.gif').css({'backgroundColor': '#000;'});
                    var div = $(document.createElement('div')).width(2).height(1).css({'backgroundColor': '#000;', position: 'absolute', left: Math.min(x1,x2)+(i*dx/d), top: Math.min(y1,y2)+(i*dy/d) });
                    //div.append(img);
                    c.append(div);
                }
            }
            
        function pathselected()
        {
            var pathname = $(this).val();
            
            var json = g_pathnames[pathname];
            
            $("#inputareatxt").val(json);
            
            inputjsonclicked(null);
        }
        function setselected(i)
        {
                       
            $("div.ball").removeClass("ballselected");
            $("#ball" + i).addClass("ballselected");
            $("#itemx").val($("#ball" + i).position().left);
            $("#itemy").val($("#ball" + i).position().top);
            $("#itemordinal").val(i);
            e = $("#ball"+ (i) + ">.ball")[0];
            rotation = $("#ball" + i).attr("rot");
            if(rotation == null)
            {
                rotation = 0;
            }
            $("#itemrotation").val(rotation);
            drawcanvas(e);
            //console.log(i + " " + $("#ball" + i).position().left);
            
            
        }
        function balldrag(event, ui)
        {
            $("#itemx").val($("#"+event.target.id).position().left);
            $("#itemy").val($("#"+event.target.id).position().top);
        }
        function ballclicked()
        {
            
            //console.log($(this)[0].id.substr("ball".length));
            setselected(parseInt($(this)[0].id.substr("ball".length)));
        }
        function balldragstart(event,ui)
        {
            //console.log("balldragstart");
            setselected(parseInt($(event.target)[0].id.substr("ball".length)));
        }
        function balldragstop(event,ui)
        {
            //console.log("balldragstart");
            rendersegments();
        }
            
        function segmenthover()
        {
            $(this).css('cursor','pointer');
            $(this).css("background-color","red");
        }
        function segmentunhover()
        {
             $(this).css('cursor','auto');
            $(this).css("background-color","white");
        }
        function segmentdoubleclick(e)
        {
            $( "#dialog-form" ).dialog( "option" ,{ position: [e.pageX, e.pageY] });
            $( "#dialog-form" ).dialog( "open" );
            $("#dialog-form").attr("active_segment",e.target.id);
            $("#time").val($("#defaulttime").val());
        }
        function rendersegment(p1, p2)
        {
            x1 = $("#ball" + p1).position().left;
            y1 = $("#ball" + p1).position().top;
            x2 = $("#ball" + p2).position().left;
            y2 = $("#ball" + p2).position().top;
            
            timestr = "";
            id = p1+"_"+p2;
            if(id in g_segment_times)
            {
                timestr = g_segment_times[id];
            }
            else
            {
                timestr = $("#defaulttime").val();
                if(timestr == null || timestr == "")
                {
                    timestr = 5;
                }
            }
            str = "segment: " + p1 + "-->" + p2 +  ":(" + x1 + "," + y1 + "), (" + x2 + "," + y2 + ") time: " + timestr + "s";
            var img = $(document.createElement('p')).html(str);
            
            img.attr("id",p1+"_"+p2);
            img.css("font-size","10px");
            $("#leftbar").append(img);
            
            $("#"+id).hover(segmenthover,segmentunhover);
            $("#"+id).dblclick(segmentdoubleclick);
                        
        }
        function rendersegments()
        {
            $("#leftbar").empty();
            n = g_numberdudes;
            if(n == 1)
            {
                return;
            }
            
            for(x=1; x <= n ; x++)
            {
                if(x+1 > n)
                {
                    continue;
                }
                rendersegment(x,x+1);
            }
        }
            
            function drawcanvas(e)
            {
                if(e == null)
                return;
                
                
                var context = e.getContext('2d');
                var rectWidth = e.width;
                var rectHeight = e.height;
                
                
                context.fillStyle = 'black';
                context.fillRect(0, 0,rectWidth, rectHeight);
               
                context.beginPath();
                
                var degrees = $("#" + e.parentNode.id).attr("rot");
                if(degrees == null)
                {
                    degrees = 0;
                }
                radians = degrees * Math.PI/180;
                
               
                
                newy = -(Math.cos(radians)*rectHeight/2) +  rectHeight/2;
                newx = Math.sin(radians)*rectWidth/2 + rectWidth/2;
                context.moveTo(rectWidth/2,rectHeight/2);
                
                context.lineTo(newx,newy);
                context.strokeStyle="red";
                context.stroke();
                
            }
        function adddude(x,y)
        {
            g_numberdudes++;
            
            strstyle = "style='position:absolute; top:" + y + "px; left:" + x + "px;'";
            //console.log(strstyle);
            
            //$("#main").append("<div id='ball" + g_numberdudes + "' class='ball' " + strstyle + " id='ball'>" +"<img class ='ball' src='ball.jpg' >" + g_numberdudes + "</div>");
            divid = "ball" + g_numberdudes;
            
            canvasid = "canvas" + g_numberdudes;
            $("#main").append("<div id='"+ divid +  "' class='ball' " + strstyle + " id='ball'>" +canvashtml(g_numberdudes) + "</div>");
            
            jqdivid = "#" + divid;
            jqcanvasid = "#" + canvasid;
            var rot = ($("#itemrotation").val());
            if(rot == null || rot == "")
            {
                rot = 0;
            }
            
            
            if(g_numberdudes > 1)
            {
                var segmentid = g_numberdudes-1 + "_" + g_numberdudes;
                g_segment_times[segmentid] = $("#defaulttime").val();
                
            }
            
            $(jqdivid).attr("rot",rot);
            $( jqdivid ).draggable();
            $( jqdivid ).on( "drag", balldrag );
            $( jqdivid ).on( "dragstart", balldragstart );
            $( jqdivid ).on( "dragstop", balldragstop );
            $(jqdivid).click(ballclicked);
            //console.log("ball" + g_numberdudes);
            $(jqdivid).hover(function() {
                                  $(this).css('cursor','pointer');
                                  }, function() {
                                  $(this).css('cursor','auto');
                                  });
            
            
            e = $(jqcanvasid)[0];
            drawcanvas(e);
            
            setselected(g_numberdudes);
            
            rendersegments();
            
            
            
        }
        function _getid(str)
        {
            return parseInt(str.substr("ball".length));
        }
        function canvashtml(id)
        {
            
            str = "<canvas id='canvas" + id + "' width='15' height='15' class='ball'/>" + (id);
            return str;
        }
        function reordinal(removedid)
        {
            n = $("div.ball").length;
            for(x=removedid+1; x <=n+1; x++)
            {
                jqdivid = "#ball" + x;
                newdivid = "ball" + (x-1);
                jqcanvasid = "#canvas" + x;
                rotation = $(jqdivid).attr("rot");
                newcanvasid = "canvas" + (x-1);
                jqnewcanvasid = "#" + newcanvasid;
                jqnewdivid = "#" + newdivid;
                //$("#ball"+x).html("<img class='ball' src='ball.jpg'>" + (x-1));
                $(jqdivid).empty();
                
                
                $(jqdivid).attr("id",  newdivid);
                $(jqdivid).attr("rot",  rotation);
                $(jqnewdivid).html(canvashtml(x-1));
                e = $(jqnewcanvasid)[0];
                drawcanvas(e);

                
            }
            g_numberdudes = n;
        }
            
        function clearall()
        {
                var x;
            
            for(x=1; x <= g_numberdudes; x++)
            {
                deleteball(x);
            }
            g_numberdudes = 0;
        }
        function deleteball(theid)
        {
            var s1 = "";
            var s2 = "";
            $("#ball" + theid).remove();
            
            s1 = theid + "_" + (theid+1);
            s2 = (theid-1) + "_" + theid;
            if(s1 in g_segment_times)
            {
                delete g_segment_times[s1];
            }
            if(s2 in g_segment_times)
            {
                delete g_segment_times[s2];
            }
            
        }
        function _raphaelsegmentdone()
        {
            
              /*
               go to g_current_ballid + 1
               */
            /*
             Get x,y, rotation, time to get to next point
             */
            var cx;
            var cy;
            var rot;
            var ms;
            var s;
            var i = g_current_ballid + 1;
            var segmentid;
            
            s = "#ball" + i;

            if(g_current_ballid + 1 > g_numberdudes || g_current_ballid == 0)
            {
                
                s = "#ball1";
                ms = 0;
                
                
            }
            else
            {
                segmentid = i-1 +"_"+i;
                
                
                if(segmentid in g_segment_times)
                {
                    
                    ms = g_segment_times[segmentid];
                }
                else
                {
                    ms = $("#defaulttime").val();
                    if(ms == null || ms == "")
                    {
                        timestr = 5;
                    }

                }
 
            }
            cx =  $(s).position().left;
            cy = $(s).position().top;
            rot = parseInt($(s).attr("rot"));
            
            g_current_ballid = g_current_ballid + 1;
            if(g_current_ballid > g_numberdudes)
            {
                g_current_ballid = 0;
            }
            g_set.animate({transform: "t"+cx + ","+ cy + "r"+rot},ms*1000,"linear",_raphaelsegmentdone);
            
             
            
        }
        function StartSimulator()
        {
            g_running = true;
            g_current_ballid = 1;
            $("#main").css("visibility", "hidden");
            $("#simulator").css("visibility", "visible");
            _InitRaphaelCanvas($("#simulator")[0]);
            
            /*
             * draw the origin
             */
            var x;
            var y;
            x = $("#ball1").position().left;
            y = $("#ball1").position().top;
            g_current_point= g_raphaelcanvas.rect(0,0,15,15);
            g_set.push(g_current_point);
            g_set.translate(x,y);
            
            rot = parseInt($("#ball1").attr("rot"));
            g_set.rotate(rot);
            g_set.animate({fill: "#ff0000"},0,"linear",_raphaelsegmentdone);
            
                       
            
        }
        function StopSimulator()
        {
            g_running = false;
            
            if(g_current_point != null)
            {
                g_current_point.stop();
                g_current_point = null;
            }
            $("#simulator").css("visibility", "hidden");
            
            g_raphaelcanvas.clear();
            g_raphaelcanvas.remove();
            delete g_raphaelcanvas;
            g_raphaelcanvas = null;
            $("#main").css("visibility", "visible");
            g_current_ballid = 1;
           
        }
        function runsimulatorclicked(event)
        {
            if (g_running) {
                StopSimulator();
            }
            else
            {
                StartSimulator();
            }
        }
        function outputjsonclicked(event)
        {
            var pathname = $("#pathname").val();
            var json = "";
            
            if(pathname == null || pathname == "")
            {
                alert("Path name is invalid");
                return;
            }
            json = outputJSON();
            
            $("#inputareatxt").val(json);
            g_pathnames[pathname] = json;
            
            if($("#pathnames option[value='"+pathname+"']").length <= 0)
            {
                            $("#pathnames")
                .append($("<option></option>")
                    .attr("value",pathname)
                    .text(pathname));
            }
            $("#pathnames").val(pathname);
        }
        function inputjsonclicked(event)
        {
            inputstr = $("#inputareatxt").val();
            
            var obj = jQuery.parseJSON(inputstr);
            clearall();
            $("#pathname").val(obj.path.name);
            $("#itemrotation").val(obj.path.origin.rot);
            adddude(obj.path.origin.x,obj.path.origin.y);
            var x;
            for(x=0; x < obj.path.transitions.length; x++)
            {
                $("#itemrotation").val(obj.path.transitions[x].rot);
                $("#defaulttime").val(obj.path.transitions[x].interval);
                adddude(obj.path.transitions[x].x,obj.path.transitions[x].y);
            }
            
            g_pathnames[obj.path.name] = inputstr;
            
            
            if($("#pathnames option[value='"+obj.path.name+"']").length <= 0)
            {
                $("#pathnames")
                .append($("<option></option>")
                        .attr("value",obj.path.name)
                        .text(obj.path.name));
            }
        }

        function delbuttonclicked(event)
        {
            if(event.target.id != "delbutton")
            {
                return;
            }
            
            if($(".ballselected") == null || $(".ballselected")[0] == null)
            {
                return;
            }
            //console.log($(".ballselected")[0]);
            selectedid =  _getid($(".ballselected")[0].id);
            deleteball(selectedid);
            
            if($("div.ball").last() != null && $("div.ball").last()[0] != null)
            {
                
                setselected(_getid($("div.ball").last()[0].id));
            }
            reordinal(selectedid);
            
            rendersegments();
            //i = _getid($("div.ball").last().id);
            //console.log(i);
            //console.log($("div.ball").last().removeClass("ball").addClass("ballselected"));
        }
        function mainclicked(event)
        {
            if(event.target.id == "main")
            {
                adddude(event.offsetX-10,event.offsetY-10);
            }
            //console.log(event);
        }
         
    
        function _ballToJSON(i)
        {
            var s;
            s = "#ball" + i;
            
            var segmentid;
            var str;
            str = '';
            if($(s).length == 0)
            {
                return "";
            }
            str = '{\n';
            str += '\"x\":' + '"' + $(s).position().left + '"' + ',\n';
            str += '\"y\":' + '"' + $(s).position().top + '"' + ',\n';
            str += '\"rot\":' + '"' + $(s).attr("rot") + '"';
            segmentid = i-1 +"_"+i;
                
                
            if(segmentid in g_segment_times)
            {
                str += ',\n';
                str += '"interval":"' + g_segment_times[segmentid] + '"\n';
            }
            
            str += '\n}';
            
            return str;

        }
        function outputJSON()
        {
            /*
             JSON is of form:
             {
                    "path":
                    {
                        "name" : "SquigglyPiggly",
                        "origin" :
                        {
                            "x" : "0",
                            "y" : "0",
                            "rot" : 0
                        },
                        "transitions" :
                        [
                            {
                                "x" : "100",
                                "y" : "100",
                                "rot" : "0",
                                "interval" : "3"
                            },
                            {
                                "x" : "200",
                                "y" : "200",
                                "rot" : "-30",
                                "interval" : "5"
                            }

                        ]
                    }
             }
             */
            var str = "";
            str = '{';
            str += '\n';
            str += '"path":\n';
            str += '{\n';
            str += '"name":' + '"' + $("#pathname").val() + '"' + ',\n';
            str += '"origin":\n';
            str += '{\n';
            str += '"x":' + '"' + $("#ball1").position().left + '"' + ',\n';
            str += '"y":' + '"' + $("#ball1").position().top + '"' + ',\n';
            str += '"rot":' + '"' + $("#ball1").attr("rot") + '"' + '\n';
            str += '},\n';
            str += '"transitions":' + '\n';
            str += '[\n';
            var i;
            var n;
            n = g_numberdudes;
            
            for(i=2; i <=n; i++)
            {
                
                str += _ballToJSON(i);
                if(i < n)
                {
                    str += ',\n';
                }
                
                
            }
            str += '\n]\n';
            str += '}\n';
            str += '}\n';
            
            return str;
                       
        }
            
            $("#main").click(mainclicked).mousemove(mainmousemove);
            $("#delbutton").click(delbuttonclicked);
            $("#outputjson").click(outputjsonclicked);
            $("#inputjson").click(inputjsonclicked);
            $("#runsimulator").click(runsimulatorclicked);
            $(document).keyup(function(e) {
                              
                              if (e.keyCode == 27) { console.log("esc");}   // esc
                              });
            
        </script>
    </body>
    
</html>
